# 📦 מערכת ניהול מלאי מתקדמת - תיעוד מלא

## 🎯 סקירה כללית

מערכת מקיפה לניהול מלאי עם הפרדה בין מחסן לחנות, ניהול מכירות, CRM, וחשבוניות מס רשמיות.

---

## 📋 תוכן עניינים

1. [ניהול מלאי לפי מיקום](#ניהול-מלאי-לפי-מיקום)
2. [מערכת מכירות משופרת](#מערכת-מכירות-משופרת)
3. [חשבוניות מס](#חשבוניות-מס)
4. [סריקת ברקוד](#סריקת-ברקוד)
5. [CRM - ניהול לקוחות](#crm)

---

## 📦 ניהול מלאי לפי מיקום

### סוגי המלאי במערכת

#### 1. **מלאי חנות** 🏪 (ברירת מחדל)
- מיקום קמעונאי למכירה ללקוחות
- מלאי זמין למכירה מיידית
- מתעדכן אוטומטית בכל מכירה
- **במכירות תמיד נבחרת חנות כברירת מחדל**

#### 2. **מלאי מחסן** 🏭
- מיקום אחסון מרכזי
- מלאי גדול לטווח ארוך
- מקור לאספקת החנויות
- **לא ניתן למכור ישירות מהמחסן**

#### 3. **מלאי כללי** 📊
- סך הכל מלאי בכל המיקומים (חנויות + מחסנים)
- חישוב אוטומטי
- תצוגה כללית למנהלים

### מודל ProductLocationStock

```python
class ProductLocationStock(models.Model):
    product = ForeignKey(Product)      # המוצר
    location = ForeignKey(Location)    # המיקום (חנות/מחסן)
    quantity = IntegerField()          # כמות במלאי
    min_quantity = IntegerField()      # כמות מינימלית
    last_restocked = DateTimeField()   # תאריך אספקה אחרון
    last_sold = DateTimeField()        # תאריך מכירה אחרון
```

### תכונות

✅ **מעקב נפרד** - כל מיקום עם מלאי משלו
✅ **התראות אוטומטיות** - מלאי נמוך למיקום ספציפי
✅ **היסטוריה** - תאריכי אספקה ומכירה אחרונים
✅ **דוחות** - מלאי לפי מיקום, מוצר, קטגוריה

---

## 🛒 מערכת מכירות משופרת

### תהליך מכירה

#### שלב 1: פתיחת מכירה חדשה
```
/sales/add/
```

#### שלב 2: בחירת פרטים
1. **לקוח** - בחירה מרשימה או הוספה מהירה
2. **חנות** ⭐ - החנות הראשית נבחרת אוטומטית (ניתן לשנות)
3. **סטטוס** - טיוטה/מאושר/הושלם
4. **סטטוס תשלום** - ממתין/שולם/חלקי

**💡 חשוב:** רק חנויות מוצגות בבחירה (לא מחסנים). המלאי יורד מהחנות שנבחרה!

#### שלב 3: הוספת מוצרים
- **ידנית** - בחירה מרשימה
- **סריקת ברקוד** 📷 - באמצעות מצלמה
- עבור כל מוצר:
  - כמות
  - מחיר יחידה
  - אחוז הנחה
  - חישוב אוטומטי של סכום

#### שלב 4: סיכום וסגירה
- חישוב מע"מ אוטומטי (17%)
- סכום כולל
- הערות נוספות
- **שמירה**

### מה קורה ברקע?

```python
# 1. יצירת מספר חשבונית אוטומטי
invoice_number = "202510-00001"  # YYYYMM-XXXXX

# 2. הורדת מלאי מהמיקום הספציפי
location_stock.quantity -= item.quantity
location_stock.last_sold = now()
location_stock.save()

# 3. עדכון מלאי כללי
product.quantity -= item.quantity
product.save()

# 4. שמירת היסטוריית לקוח
CustomerSaleHistory.objects.create(...)
```

### הוספת לקוח מהירה

במהלך המכירה, לחיצה על **"לקוח חדש"**:

```
┌─────────────────────────────┐
│  הוספת לקוח חדש מהר        │
├─────────────────────────────┤
│  שם לקוח: *                 │
│  [__________________]       │
│                             │
│  טלפון:                     │
│  [__________________]       │
│                             │
│  אימייל:                    │
│  [__________________]       │
│                             │
│  [ביטול]  [הוסף לקוח]      │
└─────────────────────────────┘
```

הלקוח מתווסף מיד לרשימה ונבחר אוטומטית!

---

## 📄 חשבוניות מס

### חשבונית מס רשמית לפי חוקי המס בישראל

#### מספור אוטומטי
```
פורמט: YYYYMM-XXXXX
דוגמה: 202510-00001

YYYY = שנה (2025)
MM   = חודש (10)
XXXXX = מספר רץ (00001)
```

#### פרטים הכלולים בחשבונית

**פרטי המוכר/עוסק מורשה:**
- שם העסק
- ח.פ/ע.מ ⭐
- כתובת מלאה
- טלפון
- אימייל

**פרטי הלקוח/הקונה:**
- שם
- ת.ז/ח.פ (אם קיים)
- כתובת
- פרטי קשר

**פרטי המסמך:**
- מספר חשבונית ייחודי
- תאריך ושעה הנפקה
- סטטוס תשלום
- נוצר על ידי (משתמש)

**טבלת פריטים:**
```
┌────┬──────────────┬──────┬───────┬──────┬────────┬──────┬────────┐
│ #  │ תיאור       │ כמות │ מחיר  │ הנחה │ סכום   │ מע"מ │ סה"כ   │
├────┼──────────────┼──────┼───────┼──────┼────────┼──────┼────────┤
│ 1  │ מוצר A      │  2   │ 100.00│  5%  │ 190.00 │32.30 │ 222.30 │
│ 2  │ מוצר B      │  1   │  50.00│  0%  │  50.00 │ 8.50 │  58.50 │
└────┴──────────────┴──────┴───────┴──────┴────────┴──────┴────────┘
```

**סיכום:**
- סכום לפני מע"מ: ₪240.00
- מע"מ (17%): ₪40.80
- **סה"כ לתשלום: ₪280.80**

**תנאי תשלום והערות:**
- מדיניות החזרות
- תנאי תשלום
- הערות נוספות

**כותרת תחתונה:**
> "חשבונית זו הופקה בהתאם לחוק עסקאות גופים ציבוריים
> (אכיפת ניהול חשבונות ותשלום חובות מס), תשל"ו-1976"

### הפקת חשבונית

```python
# מסלול להפקה
/sales/<sale_id>/invoice/

# התבנית
inventory/templates/inventory/tax_invoice.html

# תכונות
- עיצוב מקצועי
- מוכן להדפסה (CSS @print)
- תמיכה בלוגו חברה
- אפשרות שמירה כ-PDF
```

---

## 📷 סריקת ברקוד

### QuaggaJS - סורק ברקוד מצלמה

#### תכונות
✅ עובד בדפדפן ללא התקנה
✅ תמיכה במספר מצלמות
✅ סריקה אוטומטית בזמן אמת
✅ תמיכה בפורמטים: EAN-13, EAN-8, Code-128, Code-39

#### איך זה עובד?

##### 1. פתיחת סורק הברקוד
```
לחץ על: "סרוק ברקוד" 📷
```

##### 2. בחירת מצלמה
```
┌─────────────────────────────┐
│  בחר מצלמה:                 │
│  [▼ מצלמה קדמית]            │
│  [  מצלמה אחורית]           │
└─────────────────────────────┘
```

##### 3. סריקה
```
┌─────────────────────────────┐
│                             │
│     [תצוגת מצלמה]          │
│                             │
│   ┌───────────────────┐     │
│   │  הצב ברקוד כאן   │     │
│   └───────────────────┘     │
│                             │
└─────────────────────────────┘
```

##### 4. זיהוי מוצר
```
✅ מוצר נמצא!

┌─────────────────────────────┐
│  שם: מוצר לדוגמה           │
│  קוד: 123456789012          │
│  מחיר: ₪99.90              │
│  מלאי: 45 יחידות           │
│                             │
│  [הוסף לחשבונית]           │
└─────────────────────────────┘
```

#### קוד מקוצר

```javascript
// אתחול QuaggaJS
Quagga.init({
    inputStream: {
        type: "LiveStream",
        target: document.querySelector('#scanner-video'),
        constraints: {
            facingMode: "environment"  // מצלמה אחורית
        }
    },
    decoder: {
        readers: ["ean_reader", "code_128_reader"]
    }
}, function(err) {
    if (!err) {
        Quagga.start();
    }
});

// זיהוי ברקוד
Quagga.onDetected(function(result) {
    const barcode = result.codeResult.code;
    // חיפוש מוצר לפי ברקוד
    fetch(`/api/products/search/?barcode=${barcode}`)
        .then(response => response.json())
        .then(product => {
            // הצג מוצר והוסף לחשבונית
        });
});
```

---

## 👥 CRM - ניהול לקוחות

### תכונות CRM

#### 1. **פרטי לקוח**
- שם, ת.ז/ח.פ
- פרטי קשר (טלפון, אימייל)
- כתובת מלאה
- סוג לקוח: פרטי/עסקי/סיטונאי
- עדיפות: רגיל/גבוהה/VIP

#### 2. **היסטוריית רכישות**
```python
CustomerSaleHistory
- לקוח → מכירה
- סכום רכישה
- תאריך
- מוצרים שנרכשו
```

#### 3. **הערות והתראות**
```python
CustomerNote
- הערה חופשית
- תאריך
- נוצר על ידי

CustomerAlert
- התראות אוטומטיות
- יום הולדת
- תשלום באיחור
- מגבלת אשראי
```

#### 4. **דוחות לקוחות**
- לקוחות מובילים (לפי סכום רכישה)
- לקוחות לא פעילים
- התפלגות לפי עיר
- התפלגות לפי סוג

---

## 🎯 זרימת עבודה מלאה - דוגמה

### תרחיש: מכירה בחנות

#### שלב 1: פתיחת המכירה
```
קופאי נכנס למערכת → מכירות → מכירה חדשה
```

#### שלב 2: בחירת לקוח
```
אם קיים: בחירה מרשימה
אם חדש: לחץ "לקוח חדש" → מלא פרטים → שמור
```

#### שלב 3: בחירת מיקום
```
בחר: "חנות תל אביב" 🏪
המלאי יורד מהחנות הזו!
```

#### שלב 4: הוספת מוצרים

**אופציה א': ידנית**
```
בחר מוצר → הזן כמות → המשך
```

**אופציה ב': סריקה**
```
1. לחץ "סרוק ברקוד" 📷
2. אפשר גישה למצלמה
3. הצב ברקוד מול המצלמה
4. זיהוי אוטומטי! ✅
5. לחץ "הוסף לחשבונית"
```

#### שלב 5: סיכום
```
מוצר A: 2 × ₪100 = ₪200
מוצר B: 1 × ₪50  = ₪50
─────────────────────────
סכום לפני מע"מ: ₪250
מע"מ (17%):      ₪42.50
─────────────────────────
סה"כ לתשלום:    ₪292.50
```

#### שלב 6: תשלום
```
בחר: "שולם" 💳
שמור מכירה
```

#### שלב 7: חשבונית
```
מספר חשבונית: 202510-00123
לחץ "הפק חשבונית מס" 📄
הדפס או שמור PDF
```

### מה קרה ברקע?

```
1. נוצר מספר חשבונית ייחודי: 202510-00123
2. מלאי בחנות תל אביב:
   - מוצר A: 50 → 48 (-2)
   - מוצר B: 30 → 29 (-1)
3. מלאי כללי:
   - מוצר A: 150 → 148 (-2)
   - מוצר B: 80 → 79 (-1)
4. היסטוריית לקוח:
   - נוסף רשום רכישה
   - עודכן תאריך רכישה אחרונה
   - עודכן סה"כ רכישות
5. חשבונית מס נוצרה ומוכנה להדפסה
```

---

## 📊 דוחות ותצוגות

### 1. דוח מלאי לפי מיקום
```
מוצר          | מחסן ראשי | חנות ת"א | חנות חיפה | סה"כ
──────────────┼───────────┼──────────┼───────────┼──────
מוצר A        |    100    |    30    |    20     |  150
מוצר B        |     50    |    15    |    15     |   80
מוצר C        |     75    |    20    |    10     |  105
```

### 2. דוח מכירות לפי מיקום
```
חנות          | מכירות היום | שבוע | חודש
──────────────┼─────────────┼──────┼───────
חנות ת"א      |   ₪12,500  | ₪85K | ₪340K
חנות חיפה     |    ₪8,300  | ₪60K | ₪250K
סה"כ          |   ₪20,800  |₪145K | ₪590K
```

### 3. התראות מלאי נמוך
```
⚠️  מוצר A בחנות ת"א - נותרו 5 יחידות (מינימום: 10)
⚠️  מוצר C במחסן ראשי - נותרו 12 יחידות (מינימום: 20)
🔴 מוצר D בחנות חיפה - אזל מהמלאי!
```

---

## 🔧 הגדרות מערכת

### תבניות חשבוניות

נתיב: `/invoice-templates/`

```python
InvoiceTemplate:
- שם תבנית
- שם חברה
- ח.פ/ע.מ
- כתובת
- טלפון
- אימייל
- לוגו (אופציונלי)
- טקסט כותרת תחתונה
- ברירת מחדל (כן/לא)
```

### הגדרת מיקומים

נתיב: `/locations/`

```python
Location:
- שם מיקום
- סוג: חנות (ברירת מחדל) / מחסן
- כתובת
- עיר
- מנהל
- קיבולת
- סטטוס: פעיל/לא פעיל
- חנות ראשית (כן/לא) - נבחרת אוטומטית במכירות
- מחסן ראשי (כן/לא)
```

**💡 טיפ:** סמן חנות אחת כ"חנות ראשית" - היא תיבחר אוטומטית בכל מכירה חדשה!

---

## 🚀 טיפים לשימוש

### 1. הגדרת מלאי ראשוני
```
1. צור מיקומים (מחסן + חנויות)
2. הוסף מוצרים
3. הגדר מלאי לכל מיקום:
   מנהל → מלאי מוצרים במיקומים
```

### 2. העברת מלאי בין מיקומים
```
העברות → העברה חדשה
מקור: מחסן ראשי
יעד: חנות ת"א
מוצרים: [בחר ו הזן כמויות]
שמור
```

### 3. סריקת ברקוד מהירה
```
טיפ: השתמש במצלמה האחורית של הטלפון
טיפ: ודא תאורה טובה
טיפ: הצב את הברקוד במרכז האזור המסומן
```

### 4. חיפוש מהיר
```
מוצרים: Ctrl+F בדפדפן
לקוחות: השתמש בשדה חיפוש
מכירות: סנן לפי תאריך/סטטוס
```

---

## 📱 תמיכה במכשירים

### Desktop 💻
✅ Chrome, Firefox, Edge, Safari
✅ רזולוציה: 1366×768 ומעלה
✅ כל התכונות זמינות

### Tablet 📱
✅ iPad, Android Tablets
✅ רזולוציה: 768px ומעלה
✅ תפריט responsive

### Mobile 📲
✅ iOS, Android
✅ רזולוציה: 375px ומעלה
✅ ממשק מותאם למגע
✅ סריקת ברקוד אופטימלית

---

## 🔐 אבטחה והרשאות

### רמות גישה

#### 1. **מנהל מערכת**
- גישה מלאה
- ניהול משתמשים
- הגדרות מערכת
- כל הדוחות

#### 2. **מנהל**
- ניהול מלאי
- ניהול מכירות
- דוחות
- ללא הרשאות מערכת

#### 3. **קופאי**
- מכירות בלבד
- צפייה במלאי
- הוספת לקוחות
- ללא גישה לדוחות

---

## 🎓 שאלות נפוצות

### ש: מה קורה אם אין מלאי מספיק בחנות?
**ת:** המערכת תציג שגיאה. יש להעביר מלאי מהמחסן או לבטל את הפריט מהחשבונית.

### ש: האם אפשר למכור ללא לקוח?
**ת:** כן, שדה הלקוח אינו חובה. תוכל להשאיר "לקוח כללי".

### ש: האם חשבונית ניתנת לעריכה?
**ת:** חשבונית שנוצרה אינה ניתנת לעריכה (לפי חוקי המס). יש ליצור חשבונית זיכוי במקרה הצורך.

### ש: איך מעבירים מלאי בין מיקומים?
**ת:** העברות → העברה חדשה → בחר מקור ויעד → הוסף מוצרים → שמור.

### ש: האם הסריקה עובדת בלי אינטרנט?
**ת:** הסריקה עצמה כן (במצלמה), אך החיפוש במאגר המוצרים דורש חיבור לשרת.

---

## 📞 תמיכה טכנית

### בעיות נפוצות ופתרונות

#### בעיה: סריקת ברקוד לא עובדת
```
✓ בדוק הרשאת מצלמה בדפדפן
✓ רענן את הדף
✓ נסה מצלמה אחרת
✓ ודא HTTPS (נדרש לגישה למצלמה)
```

#### בעיה: מלאי לא מתעדכן
```
✓ בדוק שבחרת מיקום במכירה
✓ ודא שהמכירה נשמרה בהצלחה
✓ בדוק ב"מלאי מוצרים במיקומים"
```

#### בעיה: חשבונית לא מוצגת נכון
```
✓ בדוק שמוגדרת תבנית חשבונית
✓ מלא פרטי חברה בתבנית
✓ רענן את הדף
✓ נסה דפדפן אחר
```

---

## 🎉 סיכום

מערכת ניהול מלאי מתקדמת עם:

✅ **הפרדת מלאי** - מחסן, חנות, כללי
✅ **מכירות חכמות** - עם סריקת ברקוד
✅ **חשבוניות מס** - רשמיות ומלאות
✅ **CRM מלא** - ניהול לקוחות מקיף
✅ **דוחות** - מפורטים ושימושיים
✅ **נגישות** - Desktop, Tablet, Mobile

**המערכת מוכנה לשימוש מלא! 🚀**

---

**גרסה:** 2.0
**תאריך עדכון:** 04/10/2025
**מפתח:** מערכת ניהול מלאי מתקדמת

