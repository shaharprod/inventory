{% extends 'inventory/base.html' %}

{% block title %}הגדרות מערכת - מערכת ניהול מלאי{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-cog me-2"></i>הגדרות מערכת</h2>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-right me-1"></i>חזור לדשבורד
            </a>
        </div>

        <form method="post" id="settingsForm">
            {% csrf_token %}

            <!-- הגדרות Email -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-envelope me-2"></i>הגדרות שרת Email (SMTP)</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>הוראות:</strong> עבור Gmail, צריך ליצור App Password ב-
                        <a href="https://myaccount.google.com/security" target="_blank">Google Security Settings</a>
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                {{ form.email_enabled }}
                                <label class="form-check-label" for="{{ form.email_enabled.id_for_label }}">
                                    <strong>{{ form.email_enabled.label }}</strong>
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.email_host.id_for_label }}" class="form-label">
                                {{ form.email_host.label }}
                            </label>
                            {{ form.email_host }}
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="{{ form.email_port.id_for_label }}" class="form-label">
                                {{ form.email_port.label }}
                            </label>
                            {{ form.email_port }}
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">פרוטוקול</label>
                            <div>
                                <div class="form-check">
                                    {{ form.email_use_tls }}
                                    <label class="form-check-label" for="{{ form.email_use_tls.id_for_label }}">
                                        {{ form.email_use_tls.label }}
                                    </label>
                                </div>
                                <div class="form-check">
                                    {{ form.email_use_ssl }}
                                    <label class="form-check-label" for="{{ form.email_use_ssl.id_for_label }}">
                                        {{ form.email_use_ssl.label }}
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.email_host_user.id_for_label }}" class="form-label">
                                {{ form.email_host_user.label }}
                            </label>
                            {{ form.email_host_user }}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.email_host_password.id_for_label }}" class="form-label">
                                {{ form.email_host_password.label }}
                                <a href="https://myaccount.google.com/apppasswords" target="_blank" class="btn btn-sm btn-outline-info ms-2" title="הגדרת App Password">
                                    <i class="fas fa-external-link-alt me-1"></i>הגדר App Password
                                </a>
                            </label>
                            {{ form.email_host_password }}
                            <small class="text-muted d-block">App Password (16 תווים ללא רווחים)</small>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.default_from_email.id_for_label }}" class="form-label">
                                {{ form.default_from_email.label }}
                            </label>
                            {{ form.default_from_email }}
                        </div>

                        <div class="col-md-6 mb-3 d-flex align-items-end">
                            <button type="button" class="btn btn-info w-100" id="testEmailBtn">
                                <i class="fas fa-paper-plane me-1"></i>שלח מייל בדיקה
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- הגדרות דוח יומי -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-calendar-day me-2"></i>הגדרות דוח יומי</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                {{ form.daily_report_enabled }}
                                <label class="form-check-label" for="{{ form.daily_report_enabled.id_for_label }}">
                                    <strong>{{ form.daily_report_enabled.label }}</strong>
                                </label>
                            </div>
                        </div>

                        <div class="col-md-8 mb-3">
                            <label for="{{ form.daily_report_email.id_for_label }}" class="form-label">
                                {{ form.daily_report_email.label }}
                            </label>
                            {{ form.daily_report_email }}
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="{{ form.daily_report_time.id_for_label }}" class="form-label">
                                {{ form.daily_report_time.label }}
                            </label>
                            {{ form.daily_report_time }}
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>שים לב:</strong> לאחר שינוי השעה, הרץ מחדש את:
                        <code>scripts\schedule_daily_report.ps1</code>
                    </div>
                </div>
            </div>

            <!-- הגדרות התראות -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-bell me-2"></i>הגדרות התראות</h5>
                </div>
                <div class="card-body">
                    <!-- התראות מייל -->
                    <div class="border-bottom pb-3 mb-3">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-envelope me-2"></i>התראות במייל
                        </h6>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    {{ form.alert_email_enabled }}
                                    <label class="form-check-label" for="{{ form.alert_email_enabled.id_for_label }}">
                                        <strong>{{ form.alert_email_enabled.label }}</strong>
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-12 mb-3">
                                <label for="{{ form.alert_email_recipients.id_for_label }}" class="form-label">
                                    {{ form.alert_email_recipients.label }}
                                </label>
                                {{ form.alert_email_recipients }}
                                <small class="text-muted d-block">{{ form.alert_email_recipients.help_text }}</small>
                            </div>
                        </div>
                    </div>

                    <!-- הגדרות מלאי נמוך -->
                    <div class="border-bottom pb-3 mb-3">
                        <h6 class="text-danger mb-3">
                            <i class="fas fa-boxes me-2"></i>התראות מלאי נמוך
                        </h6>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    {{ form.enable_low_stock_alerts }}
                                    <label class="form-check-label" for="{{ form.enable_low_stock_alerts.id_for_label }}">
                                        <strong>{{ form.enable_low_stock_alerts.label }}</strong>
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.low_stock_threshold.id_for_label }}" class="form-label">
                                    <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                    {{ form.low_stock_threshold.label }}
                                </label>
                                {{ form.low_stock_threshold }}
                                <small class="text-muted d-block">{{ form.low_stock_threshold.help_text }}</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.critical_stock_threshold.id_for_label }}" class="form-label">
                                    <i class="fas fa-exclamation-circle text-danger me-1"></i>
                                    {{ form.critical_stock_threshold.label }}
                                </label>
                                {{ form.critical_stock_threshold }}
                                <small class="text-muted d-block">{{ form.critical_stock_threshold.help_text }}</small>
                            </div>
                        </div>

                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>הסבר:</strong> המערכת תתריע כאשר כמות המלאי תרד מתחת לסף שהוגדר.
                            <br>• <strong>מלאי נמוך</strong> = התראה רגילה (צהוב)
                            <br>• <strong>מלאי קריטי</strong> = התראה דחופה (אדום)
                        </div>
                    </div>

                    <!-- הגדרות תפוגה -->
                    <div>
                        <h6 class="text-info mb-3">
                            <i class="fas fa-calendar-times me-2"></i>התראות תאריך תפוגה
                        </h6>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    {{ form.enable_expiry_alerts }}
                                    <label class="form-check-label" for="{{ form.enable_expiry_alerts.id_for_label }}">
                                        <strong>{{ form.enable_expiry_alerts.label }}</strong>
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.expiry_alert_days.id_for_label }}" class="form-label">
                                    <i class="fas fa-clock text-warning me-1"></i>
                                    {{ form.expiry_alert_days.label }}
                                </label>
                                {{ form.expiry_alert_days }}
                                <small class="text-muted d-block">{{ form.expiry_alert_days.help_text }}</small>
                            </div>
                        </div>

                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-lightbulb me-2"></i>
                            <strong>טיפ:</strong> מומלץ להגדיר התראה 30 ימים לפני תפוגה כדי להספיק למכור או להחליף את המוצר.
                        </div>
                    </div>
                </div>
            </div>

            <!-- כפתורי שמירה -->
            <div class="row">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>שמור הגדרות
                    </button>
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-times me-2"></i>ביטול
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // כפתור בדיקת מייל
    document.getElementById('testEmailBtn').addEventListener('click', function() {
        const btn = this;
        const originalText = btn.innerHTML;

        // בדוק שהמשתמש שמר את ההגדרות
        if (!confirm('⚠️ שים לב: על מנת לבדוק את הגדרות המייל, עליך לשמור את השינויים תחילה.\n\nהאם ברצונך להמשיך?')) {
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>שולח...';

        fetch('/settings/test-email/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
            } else {
                alert('❌ ' + data.error);
            }
        })
        .catch(error => {
            alert('❌ שגיאה בשליחת המייל: ' + error);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    });

    // פונקציה לקבלת CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }

    // טיפול אוטומטי בסיסמת App Password
    const passwordField = document.getElementById('{{ form.email_host_password.id_for_label }}');
    if (passwordField) {
        passwordField.addEventListener('paste', function(e) {
            // המתן קצת ואז נקה את השדה
            setTimeout(() => {
                let password = this.value;
                // הסר כל הרווחים
                password = password.replace(/\s/g, '');
                // קח רק 16 תווים ראשונים
                password = password.substring(0, 16);
                // עדכן את השדה
                this.value = password;

                // הצג הודעה אם הסיסמה נוקתה
                if (password.length < 16 && this.value.length > 16) {
                    showNotification('הסיסמה קוצרה ל-16 תווים', 'info');
                }
            }, 100);
        });

        // טיפול גם בהקלדה
        passwordField.addEventListener('input', function() {
            let password = this.value;
            // הסר רווחים
            password = password.replace(/\s/g, '');
            // הגבל ל-16 תווים
            if (password.length > 16) {
                password = password.substring(0, 16);
            }
            this.value = password;
        });
    }

    // פונקציה להצגת הודעות
    function showNotification(message, type = 'info') {
        const notification = document.createElement('div');
        notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
        notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        document.body.appendChild(notification);

        // הסר אוטומטית אחרי 3 שניות
        setTimeout(() => {
            if (notification.parentNode) {
                notification.parentNode.removeChild(notification);
            }
        }, 3000);
    }
});
</script>
{% endblock %}

