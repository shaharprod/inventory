{% extends 'inventory/base.html' %}

{% block title %}×”×’×“×¨×•×ª ××¢×¨×›×ª - ××¢×¨×›×ª × ×™×”×•×œ ××œ××™{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-cog me-2"></i>×”×’×“×¨×•×ª ××¢×¨×›×ª</h2>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-right me-1"></i>×—×–×•×¨ ×œ×“×©×‘×•×¨×“
            </a>
        </div>

        <!-- ×”×ª×¨××ª Console Backend -->
        <div class="alert alert-warning mb-4" style="border-right: 5px solid #ffc107;">
            <div class="d-flex align-items-start">
                <i class="fas fa-exclamation-triangle fa-2x me-3 mt-1" style="color: #ffc107;"></i>
                <div class="flex-grow-1">
                    <h5 class="alert-heading mb-2">ğŸ’¡ ×—×©×•×‘ ×œ×”×‘×™×Ÿ: Console Backend vs SMTP</h5>
                    <p class="mb-2">
                        <strong>×”××¢×¨×›×ª ×©×œ×š ×›×¨×’×¢:</strong>
                        <span class="badge bg-success">Console Backend (×‘×¨×™×¨×ª ××—×“×œ)</span>
                    </p>
                    <p class="mb-2">
                        <strong>××” ×–×” ××•××¨?</strong><br>
                        â€¢ ×”×“×•×—×•×ª <strong>×œ× × ×©×œ×—×™× ×œ××™×™×œ ×××™×ª×™</strong><br>
                        â€¢ ×”×“×•×—×•×ª <strong>××•×“×¤×¡×™× ×‘×˜×¨××™× ×œ</strong> (×—×œ×•×Ÿ ×”×©×¨×ª)<br>
                        â€¢ ×”×”×’×“×¨×•×ª ×œ××˜×” <strong>×œ× ××©×¤×™×¢×•×ª</strong> (××•×©×‘×ª×•×ª ××•×˜×•××˜×™×ª)<br>
                        â€¢ ×–×” <strong>××•×©×œ× ×œ×¤×™×ª×•×—</strong> - ×œ× ×¦×¨×™×š App Password
                    </p>
                    <hr>
                    <p class="mb-2">
                        <strong>×¨×•×¦×” ××™×™×œ×™× ×××™×ª×™×™×?</strong> ×¦×¨×™×š ×œ×”×—×œ×™×£ ×œ-<strong>SMTP Backend</strong>:
                    </p>
                    <div class="d-flex gap-2 flex-wrap">
                        <button type="button" class="btn btn-sm btn-info" onclick="window.open('enable_gmail_smtp.ps1')">
                            <i class="fas fa-terminal me-1"></i>×”×¨×¥: enable_gmail_smtp.ps1
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="window.open('setup_gmail_smtp_hebrew.md')">
                            <i class="fas fa-book me-1"></i>××“×¨×™×š Gmail SMTP
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="window.open('SMTP_ERROR_FIX_GUIDE.md')">
                            <i class="fas fa-question-circle me-1"></i>×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <form method="post" id="settingsForm">
            {% csrf_token %}

            <!-- ×”×’×“×¨×•×ª Email -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-envelope me-2"></i>×”×’×“×¨×•×ª ×©×¨×ª Email (SMTP)
                        <span class="badge bg-warning text-dark float-end">×¨×§ ×× SMTP Backend ××•×¤×¢×œ ×‘-.env</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>×”×•×¨××•×ª ××œ××•×ª:</strong>
                        <ol class="mb-0 mt-2">
                            <li>
                                <strong>×”×¤×¢×œ 2FA ×‘-Gmail:</strong>
                                <a href="https://myaccount.google.com/security" target="_blank" class="text-decoration-underline">
                                    Google Security Settings
                                </a>
                            </li>
                            <li>
                                <strong>×¦×•×¨ App Password:</strong>
                                <a href="https://myaccount.google.com/apppasswords" target="_blank" class="text-decoration-underline">
                                    Google App Passwords
                                </a>
                                (Mail â†’ Other â†’ "Inventory System")
                            </li>
                            <li>
                                <strong>×”×¢×ª×§ ××ª ×”×¡×™×¡××”</strong> (16 ×ª×•×•×™× ×¢× ×¨×•×•×—×™×) ×•×”×“×‘×§ ×œ××˜×”
                            </li>
                            <li>
                                <strong>×”×¨×¥:</strong> <code>.\enable_gmail_smtp.ps1</code> ×‘×˜×¨××™× ×œ
                            </li>
                        </ol>
                    </div>

                    <div class="alert alert-secondary mb-3">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>×œ××ª×—×™×œ×™×:</strong> ×× ×–×” × ×¨××” ××¡×•×‘×š, ×”×©××¨ ××ª <strong>Console Backend</strong> (××” ×©×™×© ×¢×›×©×™×•).
                        ×–×” ×¢×•×‘×“ ××¦×•×™×Ÿ ×œ×¤×™×ª×•×— ×•×‘×“×™×§×•×ª! ×”×“×•×—×•×ª ××•×“×¤×¡×™× ×‘×˜×¨××™× ×œ ×‘××§×•× ×œ×”×™×©×œ×— ×œ××™×™×œ.
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                {{ form.email_enabled }}
                                <label class="form-check-label" for="{{ form.email_enabled.id_for_label }}">
                                    <strong>{{ form.email_enabled.label }}</strong>
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.email_host.id_for_label }}" class="form-label">
                                {{ form.email_host.label }}
                            </label>
                            {{ form.email_host }}
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="{{ form.email_port.id_for_label }}" class="form-label">
                                {{ form.email_port.label }}
                            </label>
                            {{ form.email_port }}
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">×¤×¨×•×˜×•×§×•×œ</label>
                            <div>
                                <div class="form-check">
                                    {{ form.email_use_tls }}
                                    <label class="form-check-label" for="{{ form.email_use_tls.id_for_label }}">
                                        {{ form.email_use_tls.label }}
                                    </label>
                                </div>
                                <div class="form-check">
                                    {{ form.email_use_ssl }}
                                    <label class="form-check-label" for="{{ form.email_use_ssl.id_for_label }}">
                                        {{ form.email_use_ssl.label }}
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.email_host_user.id_for_label }}" class="form-label">
                                {{ form.email_host_user.label }}
                            </label>
                            {{ form.email_host_user }}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.email_host_password.id_for_label }}" class="form-label">
                                {{ form.email_host_password.label }}
                            </label>
                            {{ form.email_host_password }}
                            <small class="text-muted d-block">
                                <i class="fas fa-key me-1"></i>App Password (16 ×ª×•×•×™×, ×“×•×’××”: abcd efgh ijkl mnop)
                                <br><i class="fas fa-exclamation-circle me-1"></i>×œ× ×”×¡×™×¡××” ×”×¨×’×™×œ×” ×©×œ×š!
                            </small>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.default_from_email.id_for_label }}" class="form-label">
                                {{ form.default_from_email.label }}
                            </label>
                            {{ form.default_from_email }}
                        </div>

                        <div class="col-md-6 mb-3 d-flex align-items-end">
                            <button type="button" class="btn btn-info w-100" id="testEmailBtn">
                                <i class="fas fa-paper-plane me-1"></i>×©×œ×— ××™×™×œ ×‘×“×™×§×”
                            </button>
                        </div>
                    </div>

                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>×—×©×•×‘:</strong> ×›×¤×ª×•×¨ "×©×œ×— ××™×™×œ ×‘×“×™×§×”" ×™×¢×‘×•×“ ×¨×§ ××:
                        <ol class="mb-0 mt-2">
                            <li>SMTP Backend ××•×¤×¢×œ ×‘-<code>.env</code> (×”×¨×¥ <code>.\enable_gmail_smtp.ps1</code>)</li>
                            <li>App Password × ×›×•×Ÿ</li>
                            <li>×™×© ×—×™×‘×•×¨ ×œ××™× ×˜×¨× ×˜</li>
                        </ol>
                        <strong>×¢× Console Backend:</strong> ×”×›×¤×ª×•×¨ ×œ× ×™×¢×‘×•×“, ××‘×œ ×–×” ×‘×¡×“×¨!
                        ×¤×©×•×˜ ×œ×—×¥ "×©×œ×— ×“×•×— ××™×™×“×™" ×‘-Dashboard ×•×‘×“×•×§ ×‘×˜×¨××™× ×œ.
                    </div>
                </div>
            </div>

            <!-- ×”×’×“×¨×•×ª ×“×•×— ×™×•××™ -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-day me-2"></i>×”×’×“×¨×•×ª ×“×•×— ×™×•××™
                        <span class="badge bg-light text-dark float-end">âœ“ ×¢×•×‘×“ ×’× ×¢× Console Backend</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-success mb-3">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>×˜×•×‘ ×œ×“×¢×ª:</strong> ×”×’×“×¨×•×ª ××œ×• ×¢×•×‘×“×•×ª <strong>×’× ×¢× Console Backend</strong>!
                        <br>×”×“×•×—×•×ª ×¤×©×•×˜ ×™×•×“×¤×¡×• ×‘×˜×¨××™× ×œ ×‘××§×•× ×œ×”×™×©×œ×— ×œ××™×™×œ.
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                {{ form.daily_report_enabled }}
                                <label class="form-check-label" for="{{ form.daily_report_enabled.id_for_label }}">
                                    <strong>{{ form.daily_report_enabled.label }}</strong>
                                </label>
                            </div>
                        </div>

                        <div class="col-md-8 mb-3">
                            <label for="{{ form.daily_report_email.id_for_label }}" class="form-label">
                                {{ form.daily_report_email.label }}
                            </label>
                            {{ form.daily_report_email }}
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="{{ form.daily_report_time.id_for_label }}" class="form-label">
                                {{ form.daily_report_time.label }}
                            </label>
                            {{ form.daily_report_time }}
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>×©×™× ×œ×‘:</strong> ×œ××—×¨ ×©×™× ×•×™ ×”×©×¢×”, ×”×¨×¥ ××—×“×© ××ª:
                        <code>scripts\schedule_daily_report.ps1</code>
                    </div>
                </div>
            </div>

            <!-- ×”×’×“×¨×•×ª ×”×ª×¨××•×ª -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-bell me-2"></i>×”×’×“×¨×•×ª ×”×ª×¨××•×ª</h5>
                </div>
                <div class="card-body">
                    <!-- ×”×ª×¨××•×ª ××™×™×œ -->
                    <div class="border-bottom pb-3 mb-3">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-envelope me-2"></i>×”×ª×¨××•×ª ×‘××™×™×œ
                        </h6>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    {{ form.alert_email_enabled }}
                                    <label class="form-check-label" for="{{ form.alert_email_enabled.id_for_label }}">
                                        <strong>{{ form.alert_email_enabled.label }}</strong>
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-12 mb-3">
                                <label for="{{ form.alert_email_recipients.id_for_label }}" class="form-label">
                                    {{ form.alert_email_recipients.label }}
                                </label>
                                {{ form.alert_email_recipients }}
                                <small class="text-muted d-block">{{ form.alert_email_recipients.help_text }}</small>
                            </div>
                        </div>
                    </div>

                    <!-- ×”×’×“×¨×•×ª ××œ××™ × ××•×š -->
                    <div class="border-bottom pb-3 mb-3">
                        <h6 class="text-danger mb-3">
                            <i class="fas fa-boxes me-2"></i>×”×ª×¨××•×ª ××œ××™ × ××•×š
                        </h6>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    {{ form.enable_low_stock_alerts }}
                                    <label class="form-check-label" for="{{ form.enable_low_stock_alerts.id_for_label }}">
                                        <strong>{{ form.enable_low_stock_alerts.label }}</strong>
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.low_stock_threshold.id_for_label }}" class="form-label">
                                    <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                    {{ form.low_stock_threshold.label }}
                                </label>
                                {{ form.low_stock_threshold }}
                                <small class="text-muted d-block">{{ form.low_stock_threshold.help_text }}</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.critical_stock_threshold.id_for_label }}" class="form-label">
                                    <i class="fas fa-exclamation-circle text-danger me-1"></i>
                                    {{ form.critical_stock_threshold.label }}
                                </label>
                                {{ form.critical_stock_threshold }}
                                <small class="text-muted d-block">{{ form.critical_stock_threshold.help_text }}</small>
                            </div>
                        </div>

                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>×”×¡×‘×¨:</strong> ×”××¢×¨×›×ª ×ª×ª×¨×™×¢ ×›××©×¨ ×›××•×ª ×”××œ××™ ×ª×¨×“ ××ª×—×ª ×œ×¡×£ ×©×”×•×’×“×¨.
                            <br>â€¢ <strong>××œ××™ × ××•×š</strong> = ×”×ª×¨××” ×¨×’×™×œ×” (×¦×”×•×‘)
                            <br>â€¢ <strong>××œ××™ ×§×¨×™×˜×™</strong> = ×”×ª×¨××” ×“×—×•×¤×” (××“×•×)
                        </div>
                    </div>

                    <!-- ×”×’×“×¨×•×ª ×ª×¤×•×’×” -->
                    <div>
                        <h6 class="text-info mb-3">
                            <i class="fas fa-calendar-times me-2"></i>×”×ª×¨××•×ª ×ª××¨×™×š ×ª×¤×•×’×”
                        </h6>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    {{ form.enable_expiry_alerts }}
                                    <label class="form-check-label" for="{{ form.enable_expiry_alerts.id_for_label }}">
                                        <strong>{{ form.enable_expiry_alerts.label }}</strong>
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.expiry_alert_days.id_for_label }}" class="form-label">
                                    <i class="fas fa-clock text-warning me-1"></i>
                                    {{ form.expiry_alert_days.label }}
                                </label>
                                {{ form.expiry_alert_days }}
                                <small class="text-muted d-block">{{ form.expiry_alert_days.help_text }}</small>
                            </div>
                        </div>

                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-lightbulb me-2"></i>
                            <strong>×˜×™×¤:</strong> ××•××œ×¥ ×œ×”×’×“×™×¨ ×”×ª×¨××” 30 ×™××™× ×œ×¤× ×™ ×ª×¤×•×’×” ×›×“×™ ×œ×”×¡×¤×™×§ ×œ××›×•×¨ ××• ×œ×”×—×œ×™×£ ××ª ×”××•×¦×¨.
                        </div>
                    </div>
                </div>
            </div>

            <!-- ×›×¤×ª×•×¨×™ ×©××™×¨×” -->
            <div class="row">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>×©××•×¨ ×”×’×“×¨×•×ª
                    </button>
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-times me-2"></i>×‘×™×˜×•×œ
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // ×›×¤×ª×•×¨ ×‘×“×™×§×ª ××™×™×œ
    document.getElementById('testEmailBtn').addEventListener('click', function() {
        const btn = this;
        const originalText = btn.innerHTML;

        // ×‘×“×•×§ ×©×”××©×ª××© ×©××¨ ××ª ×”×”×’×“×¨×•×ª
        if (!confirm('âš ï¸ ×©×™× ×œ×‘: ×¢×œ ×× ×ª ×œ×‘×“×•×§ ××ª ×”×’×“×¨×•×ª ×”××™×™×œ, ×¢×œ×™×š ×œ×©××•×¨ ××ª ×”×©×™× ×•×™×™× ×ª×—×™×œ×”.\n\n×”×× ×‘×¨×¦×•× ×š ×œ×”××©×™×š?')) {
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>×©×•×œ×—...';

        fetch('/settings/test-email/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
            } else {
                alert('âŒ ' + data.error);
            }
        })
        .catch(error => {
            alert('âŒ ×©×’×™××” ×‘×©×œ×™×—×ª ×”××™×™×œ: ' + error);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    });

    // ×¤×•× ×§×¦×™×” ×œ×§×‘×œ×ª CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}

