{% extends 'inventory/base.html' %}

{% block title %}הגדרות מערכת - מערכת ניהול מלאי{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2><i class="fas fa-cog me-2"></i>הגדרות מערכת</h2>
            <a href="{% url 'dashboard' %}" class="btn btn-secondary">
                <i class="fas fa-arrow-right me-1"></i>חזור לדשבורד
            </a>
        </div>

        <!-- התראת Console Backend -->
        <div class="alert alert-warning mb-4" style="border-right: 5px solid #ffc107;">
            <div class="d-flex align-items-start">
                <i class="fas fa-exclamation-triangle fa-2x me-3 mt-1" style="color: #ffc107;"></i>
                <div class="flex-grow-1">
                    <h5 class="alert-heading mb-2">💡 חשוב להבין: Console Backend vs SMTP</h5>
                    <p class="mb-2">
                        <strong>המערכת שלך כרגע:</strong>
                        <span class="badge bg-success">Console Backend (ברירת מחדל)</span>
                    </p>
                    <p class="mb-2">
                        <strong>מה זה אומר?</strong><br>
                        • הדוחות <strong>לא נשלחים למייל אמיתי</strong><br>
                        • הדוחות <strong>מודפסים בטרמינל</strong> (חלון השרת)<br>
                        • ההגדרות למטה <strong>לא משפיעות</strong> (מושבתות אוטומטית)<br>
                        • זה <strong>מושלם לפיתוח</strong> - לא צריך App Password
                    </p>
                    <hr>
                    <p class="mb-2">
                        <strong>רוצה מיילים אמיתיים?</strong> צריך להחליף ל-<strong>SMTP Backend</strong>:
                    </p>
                    <div class="d-flex gap-2 flex-wrap">
                        <button type="button" class="btn btn-sm btn-info" onclick="window.open('enable_gmail_smtp.ps1')">
                            <i class="fas fa-terminal me-1"></i>הרץ: enable_gmail_smtp.ps1
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-info" onclick="window.open('setup_gmail_smtp_hebrew.md')">
                            <i class="fas fa-book me-1"></i>מדריך Gmail SMTP
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-warning" onclick="window.open('SMTP_ERROR_FIX_GUIDE.md')">
                            <i class="fas fa-question-circle me-1"></i>פתרון בעיות
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <form method="post" id="settingsForm">
            {% csrf_token %}

            <!-- הגדרות Email -->
            <div class="card mb-4">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-envelope me-2"></i>הגדרות שרת Email (SMTP)
                        <span class="badge bg-warning text-dark float-end">רק אם SMTP Backend מופעל ב-.env</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>הוראות מלאות:</strong>
                        <ol class="mb-0 mt-2">
                            <li>
                                <strong>הפעל 2FA ב-Gmail:</strong>
                                <a href="https://myaccount.google.com/security" target="_blank" class="text-decoration-underline">
                                    Google Security Settings
                                </a>
                            </li>
                            <li>
                                <strong>צור App Password:</strong>
                                <a href="https://myaccount.google.com/apppasswords" target="_blank" class="text-decoration-underline">
                                    Google App Passwords
                                </a>
                                (Mail → Other → "Inventory System")
                            </li>
                            <li>
                                <strong>העתק את הסיסמה</strong> (16 תווים עם רווחים) והדבק למטה
                            </li>
                            <li>
                                <strong>הרץ:</strong> <code>.\enable_gmail_smtp.ps1</code> בטרמינל
                            </li>
                        </ol>
                    </div>

                    <div class="alert alert-secondary mb-3">
                        <i class="fas fa-lightbulb me-2"></i>
                        <strong>למתחילים:</strong> אם זה נראה מסובך, השאר את <strong>Console Backend</strong> (מה שיש עכשיו).
                        זה עובד מצוין לפיתוח ובדיקות! הדוחות מודפסים בטרמינל במקום להישלח למייל.
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                {{ form.email_enabled }}
                                <label class="form-check-label" for="{{ form.email_enabled.id_for_label }}">
                                    <strong>{{ form.email_enabled.label }}</strong>
                                </label>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.email_host.id_for_label }}" class="form-label">
                                {{ form.email_host.label }}
                            </label>
                            {{ form.email_host }}
                        </div>

                        <div class="col-md-3 mb-3">
                            <label for="{{ form.email_port.id_for_label }}" class="form-label">
                                {{ form.email_port.label }}
                            </label>
                            {{ form.email_port }}
                        </div>

                        <div class="col-md-3 mb-3">
                            <label class="form-label">פרוטוקול</label>
                            <div>
                                <div class="form-check">
                                    {{ form.email_use_tls }}
                                    <label class="form-check-label" for="{{ form.email_use_tls.id_for_label }}">
                                        {{ form.email_use_tls.label }}
                                    </label>
                                </div>
                                <div class="form-check">
                                    {{ form.email_use_ssl }}
                                    <label class="form-check-label" for="{{ form.email_use_ssl.id_for_label }}">
                                        {{ form.email_use_ssl.label }}
                                    </label>
                                </div>
                            </div>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.email_host_user.id_for_label }}" class="form-label">
                                {{ form.email_host_user.label }}
                            </label>
                            {{ form.email_host_user }}
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.email_host_password.id_for_label }}" class="form-label">
                                {{ form.email_host_password.label }}
                            </label>
                            {{ form.email_host_password }}
                            <small class="text-muted d-block">
                                <i class="fas fa-key me-1"></i>App Password (16 תווים, דוגמה: abcd efgh ijkl mnop)
                                <br><i class="fas fa-exclamation-circle me-1"></i>לא הסיסמה הרגילה שלך!
                            </small>
                        </div>

                        <div class="col-md-6 mb-3">
                            <label for="{{ form.default_from_email.id_for_label }}" class="form-label">
                                {{ form.default_from_email.label }}
                            </label>
                            {{ form.default_from_email }}
                        </div>

                        <div class="col-md-6 mb-3 d-flex align-items-end">
                            <button type="button" class="btn btn-info w-100" id="testEmailBtn">
                                <i class="fas fa-paper-plane me-1"></i>שלח מייל בדיקה
                            </button>
                        </div>
                    </div>

                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>חשוב:</strong> כפתור "שלח מייל בדיקה" יעבוד רק אם:
                        <ol class="mb-0 mt-2">
                            <li>SMTP Backend מופעל ב-<code>.env</code> (הרץ <code>.\enable_gmail_smtp.ps1</code>)</li>
                            <li>App Password נכון</li>
                            <li>יש חיבור לאינטרנט</li>
                        </ol>
                        <strong>עם Console Backend:</strong> הכפתור לא יעבוד, אבל זה בסדר!
                        פשוט לחץ "שלח דוח מיידי" ב-Dashboard ובדוק בטרמינל.
                    </div>
                </div>
            </div>

            <!-- הגדרות דוח יומי -->
            <div class="card mb-4">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-calendar-day me-2"></i>הגדרות דוח יומי
                        <span class="badge bg-light text-dark float-end">✓ עובד גם עם Console Backend</span>
                    </h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-success mb-3">
                        <i class="fas fa-check-circle me-2"></i>
                        <strong>טוב לדעת:</strong> הגדרות אלו עובדות <strong>גם עם Console Backend</strong>!
                        <br>הדוחות פשוט יודפסו בטרמינל במקום להישלח למייל.
                    </div>

                    <div class="row">
                        <div class="col-md-12 mb-3">
                            <div class="form-check">
                                {{ form.daily_report_enabled }}
                                <label class="form-check-label" for="{{ form.daily_report_enabled.id_for_label }}">
                                    <strong>{{ form.daily_report_enabled.label }}</strong>
                                </label>
                            </div>
                        </div>

                        <div class="col-md-8 mb-3">
                            <label for="{{ form.daily_report_email.id_for_label }}" class="form-label">
                                {{ form.daily_report_email.label }}
                            </label>
                            {{ form.daily_report_email }}
                        </div>

                        <div class="col-md-4 mb-3">
                            <label for="{{ form.daily_report_time.id_for_label }}" class="form-label">
                                {{ form.daily_report_time.label }}
                            </label>
                            {{ form.daily_report_time }}
                        </div>
                    </div>

                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>שים לב:</strong> לאחר שינוי השעה, הרץ מחדש את:
                        <code>scripts\schedule_daily_report.ps1</code>
                    </div>
                </div>
            </div>

            <!-- הגדרות התראות -->
            <div class="card mb-4">
                <div class="card-header bg-warning text-dark">
                    <h5 class="mb-0"><i class="fas fa-bell me-2"></i>הגדרות התראות</h5>
                </div>
                <div class="card-body">
                    <!-- התראות מייל -->
                    <div class="border-bottom pb-3 mb-3">
                        <h6 class="text-primary mb-3">
                            <i class="fas fa-envelope me-2"></i>התראות במייל
                        </h6>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    {{ form.alert_email_enabled }}
                                    <label class="form-check-label" for="{{ form.alert_email_enabled.id_for_label }}">
                                        <strong>{{ form.alert_email_enabled.label }}</strong>
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-12 mb-3">
                                <label for="{{ form.alert_email_recipients.id_for_label }}" class="form-label">
                                    {{ form.alert_email_recipients.label }}
                                </label>
                                {{ form.alert_email_recipients }}
                                <small class="text-muted d-block">{{ form.alert_email_recipients.help_text }}</small>
                            </div>
                        </div>
                    </div>

                    <!-- הגדרות מלאי נמוך -->
                    <div class="border-bottom pb-3 mb-3">
                        <h6 class="text-danger mb-3">
                            <i class="fas fa-boxes me-2"></i>התראות מלאי נמוך
                        </h6>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    {{ form.enable_low_stock_alerts }}
                                    <label class="form-check-label" for="{{ form.enable_low_stock_alerts.id_for_label }}">
                                        <strong>{{ form.enable_low_stock_alerts.label }}</strong>
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.low_stock_threshold.id_for_label }}" class="form-label">
                                    <i class="fas fa-exclamation-triangle text-warning me-1"></i>
                                    {{ form.low_stock_threshold.label }}
                                </label>
                                {{ form.low_stock_threshold }}
                                <small class="text-muted d-block">{{ form.low_stock_threshold.help_text }}</small>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.critical_stock_threshold.id_for_label }}" class="form-label">
                                    <i class="fas fa-exclamation-circle text-danger me-1"></i>
                                    {{ form.critical_stock_threshold.label }}
                                </label>
                                {{ form.critical_stock_threshold }}
                                <small class="text-muted d-block">{{ form.critical_stock_threshold.help_text }}</small>
                            </div>
                        </div>

                        <div class="alert alert-info mb-0">
                            <i class="fas fa-info-circle me-2"></i>
                            <strong>הסבר:</strong> המערכת תתריע כאשר כמות המלאי תרד מתחת לסף שהוגדר.
                            <br>• <strong>מלאי נמוך</strong> = התראה רגילה (צהוב)
                            <br>• <strong>מלאי קריטי</strong> = התראה דחופה (אדום)
                        </div>
                    </div>

                    <!-- הגדרות תפוגה -->
                    <div>
                        <h6 class="text-info mb-3">
                            <i class="fas fa-calendar-times me-2"></i>התראות תאריך תפוגה
                        </h6>
                        <div class="row">
                            <div class="col-md-12 mb-3">
                                <div class="form-check">
                                    {{ form.enable_expiry_alerts }}
                                    <label class="form-check-label" for="{{ form.enable_expiry_alerts.id_for_label }}">
                                        <strong>{{ form.enable_expiry_alerts.label }}</strong>
                                    </label>
                                </div>
                            </div>

                            <div class="col-md-6 mb-3">
                                <label for="{{ form.expiry_alert_days.id_for_label }}" class="form-label">
                                    <i class="fas fa-clock text-warning me-1"></i>
                                    {{ form.expiry_alert_days.label }}
                                </label>
                                {{ form.expiry_alert_days }}
                                <small class="text-muted d-block">{{ form.expiry_alert_days.help_text }}</small>
                            </div>
                        </div>

                        <div class="alert alert-warning mb-0">
                            <i class="fas fa-lightbulb me-2"></i>
                            <strong>טיפ:</strong> מומלץ להגדיר התראה 30 ימים לפני תפוגה כדי להספיק למכור או להחליף את המוצר.
                        </div>
                    </div>
                </div>
            </div>

            <!-- כפתורי שמירה -->
            <div class="row">
                <div class="col-12">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save me-2"></i>שמור הגדרות
                    </button>
                    <a href="{% url 'dashboard' %}" class="btn btn-secondary btn-lg">
                        <i class="fas fa-times me-2"></i>ביטול
                    </a>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- JavaScript -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // כפתור בדיקת מייל
    document.getElementById('testEmailBtn').addEventListener('click', function() {
        const btn = this;
        const originalText = btn.innerHTML;

        // בדוק שהמשתמש שמר את ההגדרות
        if (!confirm('⚠️ שים לב: על מנת לבדוק את הגדרות המייל, עליך לשמור את השינויים תחילה.\n\nהאם ברצונך להמשיך?')) {
            return;
        }

        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>שולח...';

        fetch('/settings/test-email/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
            } else {
                alert('❌ ' + data.error);
            }
        })
        .catch(error => {
            alert('❌ שגיאה בשליחת המייל: ' + error);
        })
        .finally(() => {
            btn.disabled = false;
            btn.innerHTML = originalText;
        });
    });

    // פונקציה לקבלת CSRF Token
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
});
</script>
{% endblock %}

