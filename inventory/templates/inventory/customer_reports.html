{% extends 'inventory/base.html' %}
{% load static %}

{% block title %}דוחות לקוחות{% endblock %}

{% block content %}
    <div class="container mt-4">
        <div class="row">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2><i class="fas fa-chart-line me-2"></i>דוחות לקוחות</h2>
                    <div>
                        <a href="{% url 'crm_dashboard' %}" class="btn btn-outline-primary me-2">
                            <i class="fas fa-arrow-right me-1"></i>חזור ל-CRM
                        </a>
                        <a href="{% url 'add_customer' %}" class="btn btn-primary">
                            <i class="fas fa-plus me-1"></i>הוסף לקוח
                        </a>
                    </div>
                </div>

                <!-- סטטיסטיקות כלליות -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <div class="card bg-primary text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h4>{{ total_customers }}</h4>
                                        <p class="mb-0">סה"כ לקוחות</p>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-users fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-success text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h4>{{ active_customers }}</h4>
                                        <p class="mb-0">לקוחות פעילים</p>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-user-check fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-warning text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h4>{{ vip_customers }}</h4>
                                        <p class="mb-0">לקוחות VIP</p>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-crown fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="card bg-danger text-white">
                            <div class="card-body">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <h4>{{ inactive_customers.count }}</h4>
                                        <p class="mb-0">לקוחות לא פעילים</p>
                                    </div>
                                    <div class="align-self-center">
                                        <i class="fas fa-user-times fa-2x"></i>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="row">
                    <!-- גרף לקוחות לפי סוג -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-chart-pie me-2"></i>לקוחות לפי סוג</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="customersByTypeChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- גרף לקוחות לפי עיר -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-map-marker-alt me-2"></i>לקוחות לפי עיר</h5>
                            </div>
                            <div class="card-body">
                                <canvas id="customersByCityChart" width="400" height="200"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- טבלאות מפורטות -->
                <div class="row">
                    <!-- לקוחות מובילים -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-trophy me-2"></i>לקוחות מובילים</h5>
                            </div>
                            <div class="card-body">
                                {% if top_customers %}
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>לקוח</th>
                                                    <th>סה"כ רכישות</th>
                                                    <th>סכום</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for customer in top_customers %}
                                                    <tr>
                                                        <td>
                                                            <a href="{% url 'customer_detail' customer.id %}">
                                                                {{ customer.name }}
                                                            </a>
                                                        </td>
                                                        <td>{{ customer.total_purchases }}</td>
                                                        <td>{{ customer.total_spent|floatformat:2 }} ₪</td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <p class="text-muted">אין נתונים זמינים</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- לקוחות ללא רכישות -->
                    <div class="col-md-6 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-exclamation-triangle me-2"></i>לקוחות ללא רכישות</h5>
                            </div>
                            <div class="card-body">
                                {% if customers_without_purchases %}
                                    <div class="table-responsive">
                                        <table class="table table-sm">
                                            <thead>
                                                <tr>
                                                    <th>לקוח</th>
                                                    <th>טלפון</th>
                                                    <th>פעולות</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for customer in customers_without_purchases %}
                                                    <tr>
                                                        <td>
                                                            <a href="{% url 'customer_detail' customer.id %}">
                                                                {{ customer.name }}
                                                            </a>
                                                        </td>
                                                        <td>{{ customer.phone|default:"-" }}</td>
                                                        <td>
                                                            <a href="{% url 'add_sale' %}?customer={{ customer.id }}" 
                                                               class="btn btn-sm btn-outline-primary">
                                                                <i class="fas fa-shopping-cart"></i>
                                                            </a>
                                                        </td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                {% else %}
                                    <p class="text-muted">כל הלקוחות ביצעו רכישות</p>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>

                <!-- לקוחות לא פעילים -->
                {% if inactive_customers %}
                <div class="row">
                    <div class="col-12 mb-4">
                        <div class="card">
                            <div class="card-header">
                                <h5><i class="fas fa-user-times me-2"></i>לקוחות לא פעילים</h5>
                            </div>
                            <div class="card-body">
                                <div class="table-responsive">
                                    <table class="table">
                                        <thead>
                                            <tr>
                                                <th>לקוח</th>
                                                <th>אימייל</th>
                                                <th>טלפון</th>
                                                <th>תאריך יצירה</th>
                                                <th>פעולות</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {% for customer in inactive_customers %}
                                                <tr>
                                                    <td>
                                                        <a href="{% url 'customer_detail' customer.id %}">
                                                            {{ customer.name }}
                                                        </a>
                                                    </td>
                                                    <td>{{ customer.email|default:"-" }}</td>
                                                    <td>{{ customer.phone|default:"-" }}</td>
                                                    <td>{{ customer.created_at|date:"d/m/Y" }}</td>
                                                    <td>
                                                        <a href="{% url 'add_sale' %}?customer={{ customer.id }}" 
                                                           class="btn btn-sm btn-outline-primary me-1">
                                                            <i class="fas fa-shopping-cart"></i>
                                                        </a>
                                                        <a href="{% url 'customer_detail' customer.id %}" 
                                                           class="btn btn-sm btn-outline-info">
                                                            <i class="fas fa-eye"></i>
                                                        </a>
                                                    </td>
                                                </tr>
                                            {% endfor %}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // גרף לקוחות לפי סוג
        const customersByTypeData = {{ customers_by_type|safe }};
        const customersByTypeCtx = document.getElementById('customersByTypeChart').getContext('2d');
        new Chart(customersByTypeCtx, {
            type: 'doughnut',
            data: {
                labels: customersByTypeData.map(item => item.customer_type),
                datasets: [{
                    data: customersByTypeData.map(item => item.count),
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false
            }
        });

        // גרף לקוחות לפי עיר
        const customersByCityData = {{ customers_by_city|safe }};
        const customersByCityCtx = document.getElementById('customersByCityChart').getContext('2d');
        new Chart(customersByCityCtx, {
            type: 'bar',
            data: {
                labels: customersByCityData.map(item => item.city || 'לא צוין'),
                datasets: [{
                    label: 'מספר לקוחות',
                    data: customersByCityData.map(item => item.count),
                    backgroundColor: '#36A2EB'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    y: {
                        beginAtZero: true
                    }
                }
            }
        });
{% endblock %}
